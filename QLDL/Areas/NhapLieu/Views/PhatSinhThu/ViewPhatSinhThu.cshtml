@model IEnumerable<QLDL.EF.PhatSinhChiThu>
@using QLDL.DAO
@using QLDL.EF
@{ 
    QLDLDBContext db = new QLDLDBContext();
}

<hr />  
<h4><b>Phát Sinh Chi </b></h4>
<div class="table-responsive">

    <table class="table table-bordered table-hover table-striped" id="dataTable" width="100%">
        <thead>
            <tr>
                <th width="1%"><input type='checkbox' id='check' value='' /></th>
                <th width="1%"></th>
                <th>Ngày Thu</th>
                <th>Người Thu</th>
                <th>Người nhận</th>
                <th>HTTT</th>
                <th>Khách Hàng</th>
                <th>Xe</th>
                <th>Mooc</th>
                <th>Tên phí</th>
                <th>Số Bill</th>
                <th>Số hoá đơn</th>
                <th>Tiền thu (VNĐ)</th>
                <th>Ghi Chú</th>
                <th>#</th>
            </tr>

        </thead>
        <tbody>

            @foreach (var ct in db.CTChiThus.Select(x => new { x.PhatSinhChiThu, x.Phi, x.DMPhi }).Distinct())
            {
                if (ct.DMPhi.LoaiPhi == 2)
                {
                    foreach (var item in Model.Where(x => x.Id == ct.PhatSinhChiThu))
                    {
                        var model = new CTThuDao().ListAll(item.Id);
                        <tr id="row_@item.Id">

                            <td><input type='checkbox' name='chkId[]' id='checkbox' value="@item.Id" /></td>
                            <td>
                                @Html.ActionLink("Chi tiết", "CTThu", new { id = item.Id }, new { @class = "btn btn-primary mb-1" })
                            </td>
                            <td>@(item.Ngay != null? item.Ngay.ToShortDateString(): null)</td>
                            <td>@(item.NguoiChiThu != null ? item.DMNhanVien1.MaNV : null)</td>
                            <td>@(item.NguoiNhan != null ? item.DMNhanVien.MaNV : null)</td>
                            <td>@(item.HTTT != null ? item.HinhThucTT.MaHT : null)</td>
                            <td>@(item.KhachHang != null ? item.DMKhachHang.MaKH : null)</td>

                            @if (model.Where(x => x.Xe != null).ToList().Count > 0)
                            {
                                <td>
                                    @Html.ActionLink("Chi tiết", "CTThu", new { id = item.Id })
                                </td>
                            }
                            else
                            {
                                <td>
                                    Null
                                </td>
                            }

                            @if (model.Where(x => x.Mooc != null).ToList().Count > 0)
                            {
                                <td>
                                    @Html.ActionLink("Chi tiết", "CTThu", new { id = item.Id })
                                </td>
                            }
                            else
                            {
                                <td>
                                    Null
                                </td>
                            }
                            @{var maphi = item.CTChiThus.Where(x => x.PhatSinhChiThu == item.Id).FirstOrDefault();}
                            <td> @(maphi.Phi != null ? maphi.DMPhi.MaPhi : null)</td>
                            @if (item.Bill != null)
                            {
                                <td>
                                    @Html.ActionLink(item.DMBill.MaBill, "CTThu", new { id = item.Id })
                                </td>
                            }
                            else
                            {
                                <td>
                                    Null
                                </td>

                            }
                            <td>@item.SoHD</td>
                            <td style="text-align: right">
                                @{ var a = 0;
                                    var tongtien = 0;
                                    foreach (var tien in item.CTChiThus)
                                    {
                                        tongtien = Convert.ToInt32(tien.DonGia) * tien.SoLuong;
                                        a += tongtien;
                                    }
                                }@String.Format("{0:0,0}", (a))
                            </td>
                            <td>@item.GhiChu</td>
                            <td>
                                @Html.ActionLink("Chỉnh sửa", "Update", new { id = item.Id }, new { @class = "btn btn-primary mb-1" })
                            </td>
                        </tr>
                    }

                }

            }

        </tbody>

    </table>
    <div class="form-group">
        <input type="submit" value="Xóa" name="delete" id="delete" class="btn btn-warning" />
    </div>


</div>


